#ifndef irc_func_cpp__#define irc_func_cpp__#include <iostream>#include <string>#include <cstdlib>#include <cstdio>#include <cstring>#include <fstream>#include <sstream>#include <sqlite3.h>#ifdef WIN32#include <winsock2.h>#else#include <sys/socket.h>#include <sys/types.h>#include <netinet/in.h>#include <arpa/inet.h>#include <netdb.h>#include <unistd.h>#endif#ifdef WIN32SOCKET sockfd;#elseint sockfd;#endif#include "irc_func.h"#include "irc_sqlite3.h"using namespace std;#define MAX_LINE  1024int saveLog=0;void irc_connect(int port, char* host){	#ifdef WIN32	WSADATA wsa;	if(WSAStartup(MAKEWORD(2,0),&wsa) != 0)		exit(1);#endif		const int PORT = port;	const char *HOST = host;	sockfd = socket(AF_INET, SOCK_STREAM, 0);		if(static_cast<int> (sockfd) < 0){		perror("socket()");		irc_disconnect();		exit(1);	}		hostent *hp = gethostbyname(HOST);	if(!hp){		cerr << "gethostbyname()" << endl;		irc_disconnect();		exit(1);	}		sockaddr_in sin;	memset((char*)&sin, 0, sizeof(sin));	sin.sin_family = AF_INET;	memcpy((char*)&sin.sin_addr, hp->h_addr, hp->h_length);	sin.sin_port =htons(PORT);	memset(&(sin.sin_zero), 0, 8*sizeof(char));		if(connect(sockfd, (sockaddr*)&sin, sizeof(sin)) == -1){		perror("connenct()");		irc_disconnect();		exit(1);	}}void irc_disconnect(){	#ifdef WIN32	closesocket(sockfd);	WSACleanup();#else	close(sockfd);#endif	}void irc_identify(){		s2u("NICK Frosch\r\n");		s2u("USER Frosch 0 0 :Frosch\r\n");		//s2u("PRIVMSG NickServ REGISTER\r\n");		s2u("JOIN #Paris\r\n");		s2u("Servus Leut«z\r\n");}void irc_receive(){	cout << "received" << endl;	for (;;) {		char buffer[MAX_LINE +1] = {0};				if(recv(sockfd, buffer, MAX_LINE * sizeof(char), 0) < 0) {			perror("recv");			irc_disconnect();			exit(1);		}			irc_parse(buffer);	}}void ping_parse(const string &buffer){		size_t pingPos = buffer.find("PING");		if(pingPos != string::npos){				string pong("PONG" + buffer.substr(pingPos + 4) + "\r\n");		cout << pong;				s2u(pong.c_str());	}	}void bot_functions(const string &buffer){		size_t pos = 0;				if ((pos = buffer.find("Botname: xxx")) != string::npos) {		string tmp(	"PRIVMSG " + buffer.substr((buffer.find(":")+1),(buffer.find("!")-1)) + " What! I«m busy.\r\n");		s2u(tmp.c_str());	}	else if(buffer.find("exit") != string::npos){		s2u("PRIVMSG #channel :bella ciao ciao\r\n");		irc_disconnect();		exit(0);	}	else if((pos = buffer.find("name")) != string::npos){		string tmp = "NICK " + buffer.substr(pos + 6) + "\r\n";		s2u(tmp.c_str());	}		else if ((pos = buffer.find("savestart")) != string::npos){		saveLog = 1;	}	else if ((pos = buffer.find("savestop")) != string::npos){		saveLog = 0;	}	else if (buffer.find("print") != string::npos) {		sql_getchat();		cout << endl;	}	else if (buffer.find("lastseen ") != string::npos) {		sql_lastseen(buffer.substr(buffer.find("lastseen ") + 9,buffer.length() -1).c_str());		cout << endl;	}	else if(buffer.find("delete") != string::npos){		sql_delete();	}			if (saveLog) {		//save data in sqlite		time_t now = time(0);				time(&now);		tm* localtm = localtime(&now);				stringstream t;		t	<< localtm->tm_year+1900	<< "-" << localtm->tm_mon << "-" << localtm->tm_mday << " " 			<< localtm->tm_hour			<< ":" << localtm->tm_min << ":" << localtm->tm_sec;				string name		(buffer.substr(buffer.find(":") +1,		buffer.find("!") -1));		string msg		(buffer.substr(buffer.find(" :") +2,	buffer.length() -1));		string channel	(buffer.substr(buffer.find("!") +1,		buffer.find("@") -1));				sql_addchat	(name.c_str(), channel.c_str(), msg.c_str(), t.str().c_str());	}	}void s2u(const char* msg){ send(sockfd, msg, strlen(msg), 0); }void irc_parse(string buffer){		if(buffer.find("\r\n") == buffer.length() -2)		buffer.erase(buffer.length() -2);		cout << buffer << endl << endl << endl;		ping_parse(buffer);		bot_functions(buffer);	}#endif